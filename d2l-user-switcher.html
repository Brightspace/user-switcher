<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../d2l-colors/d2l-colors.html">
<link rel="import" href="../d2l-dropdown/d2l-dropdown.html">
<link rel="import" href="../d2l-dropdown/d2l-dropdown-menu.html">
<link rel="import" href="../d2l-hm-constants-behavior/d2l-hm-constants-behavior.html">
<link rel="import" href="../d2l-icons/d2l-icons.html">
<link rel="import" href="../d2l-menu/d2l-menu.html">
<link rel="import" href="../d2l-menu/d2l-menu-item.html">
<link rel="import" href="../d2l-menu/d2l-menu-item-link.html">
<link rel="import" href="../d2l-user-profile-behavior/d2l-user-profile-behavior.html">
<link rel="import" href="./d2l-user-switcher-item.html">
<link rel="import" href='./localize-behavior.html'>
<link rel="import" href="icons.html">

<dom-module id="d2l-user-switcher">
	<template>
		<style>
			:host {
				min-width: 200px;
			}
			d2l-dropdown {
				display: block;
			}
			.d2l-user-switcher-opener-container {
				display: flex;
				flex-direction: row;
				align-items: center;
				background: none;
				border: none;
				outline: none;
				font-family: inherit;
				font-size: inherit;
				font-weight: inherit;
				letter-spacing: inherit;
				line-height: inherit;
				color: inherit;
				padding: 0;
				height: 100%;
			}
			p {
				margin: 0;
			}
			.pointer {
				cursor: pointer;
			}
			button:focus > d2l-icon,
			button:hover > d2l-icon,
			button:focus > p,
			button:hover > p {
				text-decoration: underline;
				color: var(--d2l-color-celestine);
			}
			.d2l-user-switcher-opener-image {
				max-width: 35px;
				max-height: 35px;
				margin-right: 10px;
				border-radius: 6px;
				overflow: hidden;
			}
			:host-context([dir="rtl"]) .d2l-user-switcher-opener-image {
				margin-left: 10px;
				margin-right: 0;
			}
			.d2l-user-switcher-opener-chevron-down {
				margin-top: auto;
				margin-bottom: auto;
				padding: 0 5px;
				width: 15px;
				height: 15px;
			}
			.user-tile-default-icon {
				--d2l-icon-height: 100%;
				--d2l-icon-width: 100%;
			}
			.text-placeholder {
				width: 150px;
				background: var(--d2l-color-titanius);
			}
			[hidden] {
				display: none;
			}
		</style>

		<template is="dom-if" if="[[hasUsers]]">
			<template is="dom-if" if="[[!multipleUsers]]">
				<div class="d2l-user-switcher-opener-container">
					<d2l-icon
						hidden$="[[_hidePlaceholderIcon(_iconUrl)]]"
						icon="navigation-48:profile"
						class="user-tile-default-icon d2l-user-switcher-opener-image">
					</d2l-icon>
					<d2l-image
						hidden$="[[!_hidePlaceholderIcon(_iconUrl)]]"
						image-url="[[_iconUrl]]"
						token="[[_token]]"
						class="d2l-user-switcher-opener-image">
					</d2l-image>
					<p hidden$="[[_hidePlaceholderName(placeholders, _name)]]" class="text-placeholder">&nbsp;</p>
					<p hidden$="[[!_hidePlaceholderName(placeholders, _name)]]">[[_name]]</p>
				</div>
			</template>
			<template is="dom-if" if="[[multipleUsers]]">
				<d2l-dropdown>
					<button class="d2l-user-switcher-opener-container pointer d2l-dropdown-opener" aria-label$="[[localize('switchUser', 'name', _name)]]">
						<d2l-icon
							hidden$="[[_hidePlaceholderIcon(_iconUrl)]]"
							icon="navigation-48:profile"
							class="user-tile-default-icon d2l-user-switcher-opener-image">
						</d2l-icon>
						<d2l-image
							hidden$="[[!_hidePlaceholderIcon(_iconUrl)]]"
							image-url="[[_iconUrl]]"
							token="[[_token]]"
							class="d2l-user-switcher-opener-image">
						</d2l-image>
						<p hidden$="[[_hidePlaceholderName(placeholders, _name)]]" class="text-placeholder">&nbsp;</p>
						<p hidden$="[[!_hidePlaceholderName(placeholders, _name)]]">[[_name]]</p>
						<d2l-icon class="d2l-user-switcher-opener-chevron-down" icon="d2l-tier1:chevron-down"></d2l-icon>
					</button>
					<d2l-dropdown-menu vertical-offset="5" no-auto-fit="false">
						<d2l-menu label="[[localize('userSwitcherMenu')]]">
							<template is="dom-repeat" items="[[parentData.entities]]">
								<d2l-user-switcher-item
									on-tap="_onItemClick"
									on-keydown="_onItemKeydown"
									user-url="[[_getUserUrl(item)]]"
									token=[[item.properties.token]]>
								</d2l-user-switcher-item>
							</template>
						</d2l-menu>
					</d2l-dropdown-menu>
				</d2l-dropdown>
			</template>
		</template>
	</template>
	<script src="https://s.brightspace.com/lib/ifrau/0.19.0/ifrau/client.js"></script>
	<script>
		'use strict';

		Polymer({
			is: 'd2l-user-switcher',

			properties: {
				parentData: Object,
				placeholders: {
					type: Boolean,
					value: false
				},
				selectedUserId: {
					type: String,
					value: null
				},
				selectedUserIconUrl: {
					type: String,
					value: null
				},
				hasUsers: {
					type: Boolean,
					value: false
				},
				multipleUsers: {
					type: Boolean,
					value: false
				},
				_token: {
					type: String,
					value: null
				},
				_iconUrl: {
					type: String,
					value: ''
				},
				_name: {
					type: String,
					value: null
				}
			},
			behaviors: [
				window.D2L.Hypermedia.HMConstantsBehavior,
				window.D2L.UserProfileBehavior,
				window.D2L.UserSwitcher.LocalizeBehavior
			],
			observers: [
				'_onSelectedUserChange( selectedUserId, parentData )'
			],
			listeners: {
				'd2l-dropdown-open': 'onOpen'
			},

			_parseEntity: function(entity) {
				return window.D2L.Hypermedia.Siren.Parse(entity);
			},
			_getUserUrl: function(user) {
				var userEntity = this._parseEntity(user);
				return (userEntity.getLinkByRel(this.HypermediaRels.user) || {}).href;
			},
			close: function() {
				this.$$('d2l-dropdown-menu').close();
			},
			onOpen: function() {
				var self = this;
				setTimeout(function() {
					self.$$('d2l-menu').focus();
				}, 0);
			},
			_onSelectedUserChange: function() {
				if (!this.parentData || !this.parentData.entities) {
					this.hasUsers = false;
					return;
				}

				var self = this;
				this.hasUsers = true;
				this.multipleUsers = false;

				if (this.parentData.entities.length > 1) {
					this.multipleUsers = true;
				}

				this.parentData.entities.forEach(function(student) {
					var studentEntity = self._parseEntity(student);
					var studentLink = studentEntity.getLinkByRel(self.HypermediaRels.user);
					var studentId = studentLink.href.match(/[0-9a-zA-Z]+$/)[0];
					if (studentId === self.selectedUserId) {
						var userUrl = self._getUserUrl(student);
						self.generateUserRequest(userUrl, student.properties.token);
					}
				});
			},
			_hidePlaceholderName: function(placeholders, name) {
				return !placeholders || !!name;
			},
			_hidePlaceholderIcon: function(icon) {
				return !!icon;
			},
			_onItemClick: function(e) {
				var data = e.model.item;
				this.close();
				this.dispatchEvent(new CustomEvent('studentSelected', { detail: { data: data }, bubbles: true }));
			},
			_onItemKeydown: function(e) {
				if (e.keyCode === 13 || e.keyCode === 32) {
					var data = e.model.item;
					this.close();
					this.dispatchEvent(new CustomEvent('studentSelected', { detail: { data: data }, bubbles: true }));
				}
			}

		});
	</script>
</dom-module>
